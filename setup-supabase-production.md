# Production Supabase Setup Guide

This guide provides step-by-step instructions to manually set up all Supabase components for production.

## 1. Database Migrations

Run these SQL commands in your Supabase SQL Editor (https://supabase.com/dashboard/project/dxtlrglnvbscuzadavod/sql):

### Migration 1: Events Table
```sql
-- 001_create_events_table.sql
CREATE TABLE IF NOT EXISTS public.events (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    date_time TIMESTAMP WITH TIME ZONE NOT NULL,
    location TEXT NOT NULL,
    price_min DECIMAL(10,2),
    price_max DECIMAL(10,2),
    category TEXT,
    organizer TEXT,
    image_url TEXT,
    source TEXT,
    external_id TEXT,
    external_url TEXT,
    capacity INTEGER,
    tickets_available INTEGER,
    tags TEXT[],
    metadata JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_events_date_time ON public.events(date_time);
CREATE INDEX IF NOT EXISTS idx_events_location ON public.events(location);
CREATE INDEX IF NOT EXISTS idx_events_category ON public.events(category);
CREATE INDEX IF NOT EXISTS idx_events_source ON public.events(source);
CREATE INDEX IF NOT EXISTS idx_events_external_id ON public.events(external_id);
```

### Migration 2: Performance Optimizations
```sql
-- 002_performance_optimizations.sql
-- Add indexes for better performance
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_events_title_trgm ON public.events USING gin(title gin_trgm_ops);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_events_description_trgm ON public.events USING gin(description gin_trgm_ops);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_events_location_trgm ON public.events USING gin(location gin_trgm_ops);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_events_tags_gin ON public.events USING gin(tags);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_events_metadata_gin ON public.events USING gin(metadata);

-- Enable Row Level Security
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;

-- Create policy for public read access
CREATE POLICY "Allow public read access" ON public.events
    FOR SELECT USING (true);

-- Create policy for authenticated users to insert/update/delete
CREATE POLICY "Allow authenticated users full access" ON public.events
    FOR ALL USING (auth.role() = 'authenticated');
```

### Migration 3: User Tables
```sql
-- 003_create_user_tables.sql
-- User profiles table
CREATE TABLE IF NOT EXISTS public.user_profiles (
    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    full_name TEXT,
    username TEXT UNIQUE,
    avatar_url TEXT,
    website TEXT,
    location TEXT,
    bio TEXT,
    date_of_birth DATE,
    phone_number TEXT,
    preferences JSONB DEFAULT '{}',
    notification_settings JSONB DEFAULT '{"email": true, "push": true, "sms": false}',
    privacy_settings JSONB DEFAULT '{"profile_visibility": "public", "show_email": false}',
    social_links JSONB DEFAULT '{}',
    verification_status TEXT DEFAULT 'unverified' CHECK (verification_status IN ('unverified', 'pending', 'verified')),
    account_status TEXT DEFAULT 'active' CHECK (account_status IN ('active', 'suspended', 'deactivated')),
    last_active_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- User favorites table
CREATE TABLE IF NOT EXISTS public.user_favorites (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    event_id BIGINT REFERENCES public.events(id) ON DELETE CASCADE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, event_id)
);

-- User event interactions table
CREATE TABLE IF NOT EXISTS public.user_event_interactions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    event_id BIGINT REFERENCES public.events(id) ON DELETE CASCADE NOT NULL,
    interaction_type TEXT NOT NULL CHECK (interaction_type IN ('viewed', 'clicked', 'shared', 'reported', 'attended', 'reviewed')),
    interaction_data JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- User saved searches table
CREATE TABLE IF NOT EXISTS public.user_saved_searches (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    search_query TEXT NOT NULL,
    search_filters JSONB DEFAULT '{}',
    name TEXT,
    is_active BOOLEAN DEFAULT true,
    notification_enabled BOOLEAN DEFAULT false,
    last_run_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_user_profiles_username ON public.user_profiles(username);
CREATE INDEX IF NOT EXISTS idx_user_profiles_location ON public.user_profiles(location);
CREATE INDEX IF NOT EXISTS idx_user_favorites_user_id ON public.user_favorites(user_id);
CREATE INDEX IF NOT EXISTS idx_user_favorites_event_id ON public.user_favorites(event_id);
CREATE INDEX IF NOT EXISTS idx_user_interactions_user_id ON public.user_event_interactions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_interactions_event_id ON public.user_event_interactions(event_id);
CREATE INDEX IF NOT EXISTS idx_user_interactions_type ON public.user_event_interactions(interaction_type);
CREATE INDEX IF NOT EXISTS idx_user_searches_user_id ON public.user_saved_searches(user_id);

-- Enable RLS
ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_favorites ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_event_interactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_saved_searches ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view their own profile" ON public.user_profiles
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile" ON public.user_profiles
    FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Users can insert their own profile" ON public.user_profiles
    FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can manage their own favorites" ON public.user_favorites
    FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own interactions" ON public.user_event_interactions
    FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can manage their own saved searches" ON public.user_saved_searches
    FOR ALL USING (auth.uid() = user_id);

-- Create trigger to auto-create user profile
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.user_profiles (id, full_name)
    VALUES (NEW.id, NEW.raw_user_meta_data->>'full_name');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

### Migration 4: Environment Variables Table
```sql
-- 004_create_environment_variables_table.sql
CREATE TABLE IF NOT EXISTS public.environment_variables (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    is_secret BOOLEAN DEFAULT true,
    category TEXT DEFAULT 'api',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS for security
ALTER TABLE public.environment_variables ENABLE ROW LEVEL SECURITY;

-- Only allow service role to access environment variables
CREATE POLICY "Service role can manage environment variables" ON public.environment_variables
    FOR ALL USING (auth.role() = 'service_role');

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_environment_variables_key ON public.environment_variables(key);
CREATE INDEX IF NOT EXISTS idx_environment_variables_category ON public.environment_variables(category);

-- Insert initial API key placeholders (update with actual values)
INSERT INTO public.environment_variables (key, value, description, category) VALUES
('TICKETMASTER_API_KEY', 'your_ticketmaster_api_key_here', 'Ticketmaster API Key for event data', 'api'),
('RAPIDAPI_KEY', 'your_rapidapi_key_here', 'RapidAPI Key for multiple event sources', 'api'),
('EVENTBRITE_API_KEY', 'your_eventbrite_api_key_here', 'Eventbrite API Key', 'api'),
('EVENTBRITE_PRIVATE_TOKEN', 'your_eventbrite_private_token_here', 'Eventbrite Private Token', 'api'),
('PREDICTHQ_API_KEY', 'your_predicthq_api_key_here', 'PredictHQ API Key for event intelligence', 'api'),
('MAPBOX_API_KEY', 'your_mapbox_api_key_here', 'Mapbox API Key for location services', 'api'),
('TOMTOM_API_KEY', 'your_tomtom_api_key_here', 'TomTom API Key for mapping', 'api'),
('OPENROUTER_API_KEY', 'your_openrouter_api_key_here', 'OpenRouter API Key for AI services', 'api')
ON CONFLICT (key) DO NOTHING;
```

## 2. Edge Functions Deployment

### Option A: Manual Deployment via Supabase Dashboard

1. Go to Edge Functions in your Supabase dashboard: https://supabase.com/dashboard/project/dxtlrglnvbscuzadavod/functions
2. Click "Create Function"
3. Name: `get-api-keys`
4. Copy the content from `supabase/functions/get-api-keys/index.ts`
5. Deploy the function

### Option B: CLI Deployment (if Docker becomes available)

```bash
# Install Supabase CLI if not already installed
npm install -g supabase

# Login to Supabase (requires access token)
supabase login

# Link to project
supabase link --project-ref dxtlrglnvbscuzadavod

# Deploy functions
supabase functions deploy get-api-keys

# Deploy database migrations
supabase db push
```

## 3. Environment Variables Setup

### Set Environment Variables for Edge Functions

1. Go to Project Settings > Edge Functions
2. Add these environment variables:
   - `TICKETMASTER_API_KEY`: Your Ticketmaster API key
   - `RAPIDAPI_KEY`: Your RapidAPI key  
   - `EVENTBRITE_API_KEY`: Your Eventbrite API key
   - `EVENTBRITE_PRIVATE_TOKEN`: Your Eventbrite private token
   - `PREDICTHQ_API_KEY`: Your PredictHQ API key
   - `MAPBOX_API_KEY`: Your Mapbox API key
   - `TOMTOM_API_KEY`: Your TomTom API key
   - `OPENROUTER_API_KEY`: Your OpenRouter API key

### Update Database Environment Variables

Run this SQL to update the actual API keys:

```sql
UPDATE public.environment_variables 
SET value = 'actual_api_key_value' 
WHERE key = 'TICKETMASTER_API_KEY';

-- Repeat for each API key
```

## 4. Verification Steps

1. **Test Database Connection**: Run `SELECT * FROM public.events LIMIT 5;`
2. **Test Edge Function**: Make a GET request to your deployed function
3. **Test Authentication**: Try signing up/logging in through your app
4. **Test Real Events**: Verify events are loading from APIs
5. **Test User Features**: Create favorites, interactions work

## 5. Production Configuration

### Update Next.js Environment Variables

Create `.env.local` with:
```
NEXT_PUBLIC_SUPABASE_URL=https://dxtlrglnvbscuzadavod.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### Update Supabase Auth Settings

1. Go to Authentication > Settings
2. Set Site URL: `https://yourdomain.com` 
3. Add redirect URLs for production
4. Configure OAuth providers if needed

## 6. Monitoring & Logs

1. Check Edge Function logs in Supabase dashboard
2. Monitor database performance
3. Set up error tracking for your Next.js app
4. Monitor API usage and rate limits

---

**Status**: All components are ready for production deployment. Follow these steps to complete the setup.